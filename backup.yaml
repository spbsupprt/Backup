---
- name: install_borg
  hosts: all
  apt:
    name: borgbackup
    update_cache: yes
    state: present
    
- name: Create user borg
  hosts: BACKUP
  user:
    name: borg
    shell: /bin/bash
    create_home: yes
    state: present
    comment: "Backup User"

- name: setup dir /var/backup
  hosts: BACKUP
  file:
    path: /var/backup
    state: directory
    owner: borg
    group: borg
    mode: '0755'
    recurse: yes

- name: clean dir /var/backup 
  hosts: BACKUP
  shell:
    cmd: "rm -rf /var/backup/* /var/backup/.* 2>/dev/null || true"
    
- name: SSH  Disable confirmation for add ssh-key Ð² known_hosts
  hosts: CLIENT
  ansible.builtin.copy:
    src: templates//disable_kh.conf
    dest: /etc/ssh/ssh_config.d/disable_check.conf
    owner: root
    group: root
    mode: '0644'
  systemd:
    name: ssh.service
    state: restarted

- name: Generate SSH key for client
  hosts: CLIENT
  community.crypto.openssh_keypair:
    path: root/.ssh/id_ed25519
    type:  "{{borg_ssh_key_type}}"
    owner: "{{ client_user }}"
    group: "{{ client_user }}"
    mode: '0600'

- name: Get public key from client
  hosts: CLIENT
  ansible.builtin.slurp:
    src: root/.ssh/id_ed25519.pub
  register: public_key

- name: Create directory (if none)
  hosts: BACKUP
  file:
    path: /home/borg/.ssh"
    state: directory
    mode: 0755

- name: Add public key client into authorized_keys in backup host
  hosts: BACKUP
  ansible.posix.authorized_key:
    user: borg  
    key: "{{ public_key.content | b64decode }}"
    state: present
    
- name: Repository init
  hosts: CLIENT
  ansible.builtin.command:
    cmd: "borg init --encryption=repokey borg@192.168.122.11:/var/backup"
    creates: "{{ repo_name }}/README"  # Check that repository created
  environment:
    BORG_PASSPHRASE: "{{ borg_repo_password }}"
    
- name: Create service
  hosts: CLIENT
  template: 
    src: templates/borg-backup.service
    dest: /etc/systemd/system/borg-backup.service
    mode: 0644

- name: Create timer
  hosts: CLIENT
  template:
    src: templates/borg-backup.timer
    dest: /etc/systemd/system/borg-backup.timer
    mode: 0644

- name: run and enable timer
  hosts: CLIENT
  systemd:
    name: borg-backup.timer
    state: started
    enabled: true
    daemon_reload: true

- name: run backup 
  hosts: CLIENT
  systemd:
    name: borg-backup.service
    state: started
    enabled: true
...
